<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Addis Bingo - Live Game</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/game.css">
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* Additional mobile styles */
        @media (max-width: 480px) {
            .game-container {
                padding: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 1.8rem;
            }
            
            .current-number {
                font-size: 3.5rem;
            }
            
            .number-letter {
                font-size: 2rem;
                width: 50px;
                height: 50px;
            }
            
            .grid-cell {
                font-size: 0.9rem;
            }
            
            .control-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
        }
        
        /* Prevent text selection */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(76, 201, 240, 0.3);
            border-radius: 50%;
            border-top-color: #4cc9f0;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 1.2rem;
            color: #4cc9f0;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="no-select">
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Connecting to game...</div>
    </div>
    
    <!-- Audio controls -->
    <div class="audio-controls">
        <button class="audio-btn" id="audioToggle">
            <i class="fas fa-volume-up"></i>
        </button>
    </div>
    
    <!-- Main game container -->
    <div class="game-container" id="gameContainer" style="display: none;">
        <!-- Game header -->
        <div class="game-header">
            <div class="game-title">
                <h1><i class="fas fa-bullhorn"></i> LIVE BINGO</h1>
                <p>Synchronized Multiplayer â€¢ Win Real Cash!</p>
            </div>
            
            <div class="game-stats">
                <div class="stat-card">
                    <div class="stat-value" id="currentNumberDisplay">--</div>
                    <div class="stat-label">Current Number</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="numbersCalled">0</div>
                    <div class="stat-label">Numbers Called</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="gameTime">00:00</div>
                    <div class="stat-label">Game Time</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="activePlayers">1</div>
                    <div class="stat-label">Players</div>
                </div>
            </div>
        </div>
        
        <!-- Game area -->
        <div class="game-area">
            <!-- Caller section -->
            <div class="caller-section">
                <div class="caller-title">
                    <h2><i class="fas fa-user-tie"></i> BINGO CALLER</h2>
                    <div class="caller-timer">
                        Next call in: <span id="nextCallTimer">5</span>s
                    </div>
                </div>
                
                <div class="current-number-container">
                    <div class="current-number-label">
                        <i class="fas fa-star"></i> CURRENTLY CALLED NUMBER
                    </div>
                    
                    <div class="current-number-display">
                        <div class="current-number" id="currentNumber">00</div>
                        <div class="number-letter" id="numberLetter">B</div>
                    </div>
                </div>
                
                <div class="called-numbers-container">
                    <h3 class="called-numbers-title">
                        <i class="fas fa-history"></i> CALLED NUMBERS
                    </h3>
                    <div class="called-numbers-grid" id="calledNumbersGrid">
                        <!-- Generated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Player cards section -->
            <div class="player-cards-section">
                <div class="player-cards-header">
                    <h2><i class="fas fa-layer-group"></i> YOUR CARDS</h2>
                    <div class="player-info-display">
                        <div class="player-avatar" id="playerAvatar">P</div>
                        <div class="player-name" id="playerName">Player</div>
                    </div>
                </div>
                
                <div class="player-cards-container" id="playerCardsContainer">
                    <!-- Cards generated by JavaScript -->
                </div>
                
                <div class="game-controls">
                    <button class="control-btn btn-auto" id="autoMarkBtn">
                        <i class="fas fa-robot"></i> AUTO-MARK: ON
                    </button>
                    
                    <button class="control-btn btn-bingo" id="bingoBtn" disabled>
                        <i class="fas fa-trophy"></i> BINGO!
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Chat container (optional) -->
        <div class="chat-container" id="chatContainer" style="display: none;">
            <div class="chat-header">
                <h3><i class="fas fa-comments"></i> GAME CHAT</h3>
                <button class="btn-close-chat" id="btnCloseChat">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Type a message...">
                <button id="btnSendChat"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    
    <!-- Audio elements -->
    <audio id="numberCallAudio" preload="auto">
        <source src="/audio/number-call.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="bingoAudio" preload="auto">
        <source src="/audio/bingo-win.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="backgroundMusic" loop preload="auto">
        <source src="/audio/background.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="readySound" preload="auto">
        <source src="/audio/ready.mp3" type="audio/mpeg">
    </audio>
    
    <!-- JavaScript -->
    <script src="/js/game-socket.js"></script>
    <script src="/js/game-engine.js"></script>
    <script src="/js/bingo-board.js"></script>
    <script src="/js/winner-display.js"></script>
    
    <script>
        // Game configuration
        const GAME_CONFIG = {
            gameId: new URLSearchParams(window.location.search).get('gameId') || 'default',
            playerId: localStorage.getItem('playerId') || 'player_' + Math.random().toString(36).substr(2, 9),
            playerName: localStorage.getItem('playerName') || 'Player',
            autoMark: true,
            audioEnabled: true
        };
        
        // Initialize game
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
        });
        
        async function initGame() {
            try {
                // Initialize Telegram Web App
                if (window.Telegram?.WebApp) {
                    const tg = window.Telegram.WebApp;
                    tg.expand();
                    tg.enableClosingConfirmation();
                    
                    // Get user data from Telegram
                    if (tg.initDataUnsafe?.user) {
                        const user = tg.initDataUnsafe.user;
                        GAME_CONFIG.playerId = user.id.toString();
                        GAME_CONFIG.playerName = user.first_name || 'Telegram User';
                        if (user.last_name) {
                            GAME_CONFIG.playerName += ' ' + user.last_name;
                        }
                    }
                }
                
                // Update UI with player info
                document.getElementById('playerName').textContent = GAME_CONFIG.playerName;
                document.getElementById('playerAvatar').textContent = 
                    GAME_CONFIG.playerName.charAt(0).toUpperCase();
                
                // Initialize game socket
                window.gameSocket = new GameSocketClient(
                    GAME_CONFIG.gameId,
                    GAME_CONFIG.playerId,
                    GAME_CONFIG.playerName
                );
                
                // Initialize game engine
                window.gameEngine = new BingoGameEngine({
                    selectionTime: 60,
                    numberInterval: 5
                });
                
                // Setup event listeners
                setupEventListeners();
                
                // Hide loading overlay
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('gameContainer').style.display = 'block';
                }, 1000);
                
            } catch (error) {
                console.error('Failed to initialize game:', error);
                document.getElementById('loadingText').textContent = 'Failed to load game';
            }
        }
        
        function setupEventListeners() {
            // Audio toggle
            document.getElementById('audioToggle').addEventListener('click', () => {
                GAME_CONFIG.audioEnabled = !GAME_CONFIG.audioEnabled;
                const icon = document.getElementById('audioToggle').querySelector('i');
                if (GAME_CONFIG.audioEnabled) {
                    icon.className = 'fas fa-volume-up';
                    gameEngine.toggleAudio(true);
                } else {
                    icon.className = 'fas fa-volume-mute';
                    gameEngine.toggleAudio(false);
                }
            });
            
            // Auto-mark toggle
            document.getElementById('autoMarkBtn').addEventListener('click', () => {
                GAME_CONFIG.autoMark = !GAME_CONFIG.autoMark;
                const btn = document.getElementById('autoMarkBtn');
                if (GAME_CONFIG.autoMark) {
                    btn.innerHTML = '<i class="fas fa-robot"></i> AUTO-MARK: ON';
                    btn.style.background = 'linear-gradient(135deg, #4CAF50, #2E7D32)';
                } else {
                    btn.innerHTML = '<i class="fas fa-robot"></i> AUTO-MARK: OFF';
                    btn.style.background = 'linear-gradient(135deg, #f44336, #c62828)';
                }
            });
            
            // BINGO button
            document.getElementById('bingoBtn').addEventListener('click', () => {
                // Implement BINGO claim logic
                claimBingo();
            });
            
            // Game socket events
            if (window.gameSocket) {
                gameSocket.on('onGameUpdate', (state) => {
                    updateGameUI(state);
                });
                
                gameSocket.on('onNumberCalled', (data) => {
                    handleNumberCalled(data);
                });
                
                gameSocket.on('onWinner', (data) => {
                    showWinner(data);
                });
                
                gameSocket.on('onError', (error) => {
                    console.error('Game error:', error);
                    alert('Game error: ' + error.message);
                });
            }
        }
        
        function updateGameUI(state) {
            // Update game stats
            document.getElementById('activePlayers').textContent = state.playerCount || 1;
            document.getElementById('numbersCalled').textContent = state.calledNumbers?.length || 0;
            
            // Update game time
            if (state.gameTime) {
                const mins = Math.floor(state.gameTime / 60);
                const secs = state.gameTime % 60;
                document.getElementById('gameTime').textContent = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
        }
        
        function handleNumberCalled(data) {
            // Update current number display
            document.getElementById('currentNumber').textContent = 
                data.number.toString().padStart(2, '0');
            document.getElementById('numberLetter').textContent = data.letter;
            document.getElementById('currentNumberDisplay').textContent = 
                `${data.letter}-${data.number}`;
            
            // Play sound
            if (GAME_CONFIG.audioEnabled) {
                document.getElementById('numberCallAudio').play().catch(e => console.log('Audio error:', e));
            }
            
            // Update called numbers grid
            updateCalledNumbersGrid(data.calledNumbers);
            
            // Auto-mark if enabled
            if (GAME_CONFIG.autoMark && window.gameEngine) {
                gameEngine.autoMarkNumber(data.number);
            }
        }
        
        function updateCalledNumbersGrid(calledNumbers) {
            const grid = document.getElementById('calledNumbersGrid');
            if (!grid) return;
            
            // Clear existing
            grid.innerHTML = '';
            
            // Create columns B-I-N-G-O
            const columns = [
                { letter: 'B', min: 1, max: 15 },
                { letter: 'I', min: 16, max: 30 },
                { letter: 'N', min: 31, max: 45 },
                { letter: 'G', min: 46, max: 60 },
                { letter: 'O', min: 61, max: 75 }
            ];
            
            columns.forEach(col => {
                const columnDiv = document.createElement('div');
                columnDiv.className = 'bingo-column';
                
                const header = document.createElement('div');
                header.className = 'column-header';
                header.textContent = col.letter;
                columnDiv.appendChild(header);
                
                const numbersDiv = document.createElement('div');
                numbersDiv.className = 'column-numbers';
                
                for (let i = col.min; i <= col.max; i++) {
                    const numberDiv = document.createElement('div');
                    numberDiv.className = 'called-number';
                    numberDiv.textContent = i;
                    numberDiv.dataset.number = i;
                    
                    if (calledNumbers.includes(i)) {
                        numberDiv.classList.add('called');
                    }
                    
                    numbersDiv.appendChild(numberDiv);
                }
                
                columnDiv.appendChild(numbersDiv);
                grid.appendChild(columnDiv);
            });
        }
        
        function claimBingo() {
            // Implement BINGO claim logic
            // This would verify the pattern and send to server
            alert('BINGO claim feature coming soon!');
        }
        
        function showWinner(winnerData) {
            // Initialize winner display
            const winnerDisplay = new WinnerDisplay('gameContainer');
            winnerDisplay.showWinner(winnerData);
        }
        
        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('Game paused');
                // Pause audio
                document.getElementById('backgroundMusic').pause();
            } else {
                console.log('Game resumed');
                // Resume audio if enabled
                if (GAME_CONFIG.audioEnabled) {
                    document.getElementById('backgroundMusic').play().catch(e => console.log('Audio error:', e));
                }
            }
        });
        
        // Handle before unload
        window.addEventListener('beforeunload', (e) => {
            if (window.gameSocket && gameSocket.isConnected()) {
                // Notify server player is leaving
                gameSocket.disconnect();
            }
        });
    </script>
</body>
</html>